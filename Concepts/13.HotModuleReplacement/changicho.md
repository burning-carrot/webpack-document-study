# Hot Module Replacement

Hot Module Replacement(HMR) : 애플리케이션이 실행되는 동안 `모듈 전체를 다시 로드하지 않고` 교환, 추가 또는 제거하는 것을 의미한다.

다음과 같은 몇 방법으로 개발 속도를 높일 수 있다.

- 전체 다시 로드 중에 손실되는 애플리케이션의 상태를 유지 (inMemory state)
- 변경된 사항만 갱신한다.
- 소스 코드에서 CSS/JS를 수정하면 브라우저에서 즉시 업데이트한다.
  - 이는 브라우저의 개발자 도구에서 직접 스타일을 변경하는 것과 거의 비슷하다.

## How It Works

### In the Application

다음 단계를 통해 애플리케이션에서 모듈을 교체할 수 있다.

1. 애플리케이션은 HMR 런타임에 업데이트된 내용을 요청한다.
2. HMR 런타임에서 업데이트된 내용을 비동기적으로 다운로드받고 애플리케이션에 알린다.
3. 애플리케이션은 런타임에 업데이트를 요청한다.
4. HMR 런타임에서 업데이트를 동기적으로 적용한다.

이 프로세스가 자동으로 발생하도록 HMR을 설정하거나, 업데이트가 발생하기 위해 사용자 상호 작용을 요구하도록 선택할 수 있다.

### In the Compiler

일반 asset 외에 컴파일러는 이전 버전에서 새 버전으로 업데이트할 수 있도록 "업데이트"를 내보내야 한다.

"업데이트"는 두 부분으로 구성된다.

- 업데이트 된 매니페스트 (JSON)
  - 새 컴파일 해시
  - 업데이트 된 모든 청크 목록
- 하나 이상의 업데이트 된 청크
  - 업데이트 된 모든 모듈에 대한 새 코드
  - 모듈이 제거되었음을 나타내는 플래그

컴파일러는 빌드 간에 모듈 ID와 청크 ID가 일치하는지 확인한다.

일반적으로 이러한 ID를 메모리에 저장하지만 (webpack-dev-server)
JSON 파일에 저장할 수도 있다.

### In a Module

HMR은 HMR 코드가 포함된 모듈에만 영향을 미치는 선택적인 기능이다.

style-loader를 통해 스타일 속성을 로드하는 것을 예시로 들 수 있다.

- 패치가 작동하기 위해 style-loader는 HMR 인터페이스를 구현
- HMR을 통해 업데이트를 받으면 이전 스타일을 새 스타일로 대체

모듈에서 HMR 인터페이스를 구현할 때 모듈이 업데이트될 때 어떤 일이 발생해야 하는지 알려줄 수 있다. (필수는 아님)

모듈에 HMR 핸들러가 없으면 업데이트가 버블링됩니다. (단일 핸들러가 전체 모듈 트리를 업데이트 할 수 있음)

트리의 단일 모듈이 업데이트되면 전체 종속성 집합이 다시 로드된다.

[HMR API 페이지](https://webpack.kr/api/hot-module-replacement/)

### In the Runtime

모듈 시스템 런타임의 경우 `부모` 및 `자식 모듈`을 추적하기 위해 추가 코드가 생성된다.

관리적인 측면에서 런타임은 `check` 그리고 `apply` 두 가지 방법을 지원한다.

#### check

check는 업데이트 매니페스트에 HTTP 요청을 한다.

1. 요청이 실패하면 가능한 업데이트가 없음을 의미함.
2. 성공하면 업데이트된 청크 목록과 현재 로드된 청크 목록을 비교한다.
3. 로드된 각 청크에 해당하는 업데이트 청크가 다운로드된다.
4. 모든 모듈 업데이트는 HMR 런타임에 저장한다.
5. 모든 업데이트 청크가 다운로드되고 적용할 준비가 되면 런타임이 ready 상태로 전환된다.

#### apply

apply는 업데이트된 모든 모듈을 유효하지 않은 것으로 표시한다.

유효하지 않은 각 모듈에 대해 해당 모듈 또는 상위 모듈에 업데이트 핸들러가 있어야 한다.

그렇지 않으면 잘못된 플래그가 버블링되고 부모도 유효하지 않게 된다.

1. 앱의 엔트리 포인트나 업데이트 핸들러가 있는 모듈에 도달할 때까지(둘 중 먼저 도달하는 곳까지) 계속 버블링된다.
   1. 엔트리 포인트에서 버블링이 발생하면 프로세스가 실패한다.
2. 그 후 모든 유효하지 않은 모듈이 (폐기 처리기를 통해) 폐기되고 언로드된다.
3. 다음 현재 해시가 업데이트되고 모든 accept 핸들러가 호출된다.
4. 런타임은 idle 상태로 다시 전환되고 모든 것이 정상적으로 계속된다.

## Get Started

HMR은 Live Reload의 대체품으로 개발에 사용할 수 있다.

webpack-dev-server는 전체 페이지를 다시 로드하기 전에 HMR로 업데이트를 시도하는 hot 모드를 지원한다.

특정 프로젝트의 필요에 따라 HMR을 구성하는 방법은 많이 있지만 대부분은 webpack-dev-server가 적합하며 HMR을 빠르게 시작할 수 있다.
